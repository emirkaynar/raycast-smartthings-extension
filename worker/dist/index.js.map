{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": "dist",
  "sourcesContent": ["export interface Env {\r\n  AUTH_KV: KVNamespace;\r\n\r\n  ST_CLIENT_ID: string;\r\n  ST_CLIENT_SECRET: string;\r\n\r\n  /** Optional; default uses PUBLIC_BASE_URL + '/v1/callback' */\r\n  ST_REDIRECT_URI?: string;\r\n\r\n  /** Optional; default is SmartThings global token URL */\r\n  ST_TOKEN_URL?: string;\r\n\r\n  /** Optional; default is SmartThings global authorize URL (may need adjustment per your app registration). */\r\n  ST_AUTHORIZATION_URL?: string;\r\n\r\n  /** Optional; space-delimited scopes. */\r\n  ST_SCOPES?: string;\r\n\r\n  /** Required if ST_REDIRECT_URI is not set. Example: https://xxx.workers.dev */\r\n  PUBLIC_BASE_URL?: string;\r\n\r\n  /** Base64-encoded 32-byte key for AES-GCM encryption of tokens */\r\n  TOKEN_ENC_KEY_B64: string;\r\n}\r\n\r\ntype PairRecord = {\r\n  status: \"pending\" | \"completed\" | \"error\";\r\n  createdAt: string;\r\n  sessionToken?: string;\r\n  error?: string;\r\n};\r\n\r\ntype TokenRecord = {\r\n  updatedAt: string;\r\n  accessTokenEnc: string;\r\n  accessTokenExpiresAt: string; // ISO\r\n  refreshTokenEnc: string;\r\n};\r\n\r\nconst JSON_HEADERS = {\r\n  \"content-type\": \"application/json; charset=utf-8\",\r\n};\r\n\r\nfunction escapeHtml(input: string): string {\r\n  return input\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\\\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#39;\");\r\n}\r\n\r\nfunction withCors(req: Request, resp: Response): Response {\r\n  const headers = new Headers(resp.headers);\r\n\r\n  // Raycast extensions run outside the browser, so CORS isn't required for normal usage,\r\n  // but it makes local/manual testing easier and doesn't rely on cookies.\r\n  headers.set(\"access-control-allow-origin\", \"*\");\r\n  headers.set(\"access-control-allow-methods\", \"GET, POST, OPTIONS\");\r\n  headers.set(\"access-control-allow-headers\", \"content-type, authorization\");\r\n  headers.set(\"access-control-max-age\", \"86400\");\r\n\r\n  // Avoid caching token responses in intermediaries.\r\n  if (!headers.has(\"cache-control\")) {\r\n    headers.set(\"cache-control\", \"no-store\");\r\n  }\r\n\r\n  return new Response(resp.body, {\r\n    status: resp.status,\r\n    statusText: resp.statusText,\r\n    headers,\r\n  });\r\n}\r\n\r\nfunction json(data: unknown, init?: ResponseInit): Response {\r\n  return new Response(JSON.stringify(data, null, 2), {\r\n    ...init,\r\n    headers: {\r\n      ...JSON_HEADERS,\r\n      ...(init?.headers || {}),\r\n    },\r\n  });\r\n}\r\n\r\nfunction badRequest(message: string, extra?: Record<string, unknown>): Response {\r\n  return json({ error: message, ...(extra || {}) }, { status: 400 });\r\n}\r\n\r\nfunction unauthorized(message = \"Unauthorized\"): Response {\r\n  return json({ error: message }, { status: 401 });\r\n}\r\n\r\nfunction notFound(): Response {\r\n  return json({ error: \"Not Found\" }, { status: 404 });\r\n}\r\n\r\nfunction randomBase64Url(bytes: number): string {\r\n  const arr = new Uint8Array(bytes);\r\n  crypto.getRandomValues(arr);\r\n  // base64url\r\n  let str = \"\";\r\n  for (const b of arr) str += String.fromCharCode(b);\r\n  const b64 = btoa(str);\r\n  return b64.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\r\n}\r\n\r\nfunction randomHex(bytes: number): string {\r\n  const arr = new Uint8Array(bytes);\r\n  crypto.getRandomValues(arr);\r\n  let out = \"\";\r\n  for (const b of arr) out += b.toString(16).padStart(2, \"0\");\r\n  return out;\r\n}\r\n\r\nfunction nowIso(): string {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction trimTrailingSlashes(input: string): string {\r\n  let end = input.length;\r\n  while (end > 0 && input.charCodeAt(end - 1) === 47) end--; // '/'\r\n  return end === input.length ? input : input.slice(0, end);\r\n}\r\n\r\nfunction splitOnAsciiWhitespace(input: string): string[] {\r\n  const parts: string[] = [];\r\n  let tokenStart = -1;\r\n\r\n  for (let i = 0; i < input.length; i++) {\r\n    const ch = input.charCodeAt(i);\r\n    const isWs = ch === 32 || ch === 9 || ch === 10 || ch === 13 || ch === 12 || ch === 11;\r\n    if (isWs) {\r\n      if (tokenStart !== -1) {\r\n        parts.push(input.slice(tokenStart, i));\r\n        tokenStart = -1;\r\n      }\r\n      continue;\r\n    }\r\n    if (tokenStart === -1) tokenStart = i;\r\n  }\r\n\r\n  if (tokenStart !== -1) parts.push(input.slice(tokenStart));\r\n  return parts;\r\n}\r\n\r\nfunction addSeconds(iso: string, seconds: number): string {\r\n  return new Date(new Date(iso).getTime() + seconds * 1000).toISOString();\r\n}\r\n\r\nfunction getBearerToken(req: Request): string | null {\r\n  const auth = req.headers.get(\"authorization\");\r\n  if (!auth) return null;\r\n  const m = auth.match(/^Bearer\\s+(.+)$/i);\r\n  return m?.[1]?.trim() || null;\r\n}\r\n\r\nasync function importAesKeyFromB64(b64: string): Promise<CryptoKey> {\r\n  const raw = Uint8Array.from(atob(b64), (c) => c.charCodeAt(0));\r\n  return crypto.subtle.importKey(\"raw\", raw, \"AES-GCM\", false, [\"encrypt\", \"decrypt\"]);\r\n}\r\n\r\nasync function encryptString(key: CryptoKey, plaintext: string): Promise<string> {\r\n  const iv = new Uint8Array(12);\r\n  crypto.getRandomValues(iv);\r\n  const data = new TextEncoder().encode(plaintext);\r\n  const ciphertext = await crypto.subtle.encrypt({ name: \"AES-GCM\", iv }, key, data);\r\n\r\n  // pack as base64url(iv) + '.' + base64url(ciphertext)\r\n  const ivB64 = btoa(String.fromCharCode(...iv))\r\n    .replace(/\\+/g, \"-\")\r\n    .replace(/\\//g, \"_\")\r\n    .replace(/=+$/g, \"\");\r\n\r\n  const ctArr = new Uint8Array(ciphertext);\r\n  let ctStr = \"\";\r\n  for (const b of ctArr) ctStr += String.fromCharCode(b);\r\n  const ctB64 = btoa(ctStr).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\r\n\r\n  return `${ivB64}.${ctB64}`;\r\n}\r\n\r\nasync function decryptString(key: CryptoKey, packed: string): Promise<string> {\r\n  const [ivB64, ctB64] = packed.split(\".\");\r\n  if (!ivB64 || !ctB64) throw new Error(\"Invalid ciphertext\");\r\n\r\n  const iv = Uint8Array.from(\r\n    atob(ivB64.replace(/-/g, \"+\").replace(/_/g, \"/\") + \"===\".slice((ivB64.length + 3) % 4)),\r\n    (c) => c.charCodeAt(0),\r\n  );\r\n\r\n  const ctBytes = Uint8Array.from(\r\n    atob(ctB64.replace(/-/g, \"+\").replace(/_/g, \"/\") + \"===\".slice((ctB64.length + 3) % 4)),\r\n    (c) => c.charCodeAt(0),\r\n  );\r\n\r\n  const plaintext = await crypto.subtle.decrypt({ name: \"AES-GCM\", iv }, key, ctBytes);\r\n  return new TextDecoder().decode(plaintext);\r\n}\r\n\r\nfunction getUrls(env: Env): { authorizeUrl: string; tokenUrl: string; redirectUri: string } {\r\n  const tokenUrl = env.ST_TOKEN_URL || \"https://auth-global.api.smartthings.com/oauth/token\";\r\n  // NOTE: SmartThings authorization URL can vary by integration type/region.\r\n  // Empirically, auth-global may respond with HTTP Basic auth; api.smartthings.com redirects to the correct user login/consent flow.\r\n  const authorizeUrl = env.ST_AUTHORIZATION_URL || \"https://api.smartthings.com/oauth/authorize\";\r\n\r\n  const redirectUri =\r\n    env.ST_REDIRECT_URI || (env.PUBLIC_BASE_URL ? `${trimTrailingSlashes(env.PUBLIC_BASE_URL)}/v1/callback` : \"\");\r\n  if (!redirectUri) {\r\n    throw new Error(\"Missing redirect URI: set ST_REDIRECT_URI or PUBLIC_BASE_URL\");\r\n  }\r\n\r\n  return { authorizeUrl, tokenUrl, redirectUri };\r\n}\r\n\r\nfunction encodeScopesForSmartThings(scopes: string): string {\r\n  // SmartThings examples show scopes like `r:devices:* x:devices:*`.\r\n  // Some OAuth servers are surprisingly picky about percent-encoded ':' and '*',\r\n  // so we keep them literal and only encode separators/spaces as '%20'.\r\n  return splitOnAsciiWhitespace(scopes)\r\n    .map((scope) =>\r\n      encodeURIComponent(scope)\r\n        .replaceAll(\"%3A\", \":\")\r\n        .replaceAll(\"%3a\", \":\")\r\n        .replaceAll(\"%2A\", \"*\")\r\n        .replaceAll(\"%2a\", \"*\"),\r\n    )\r\n    .join(\"%20\");\r\n}\r\n\r\nasync function exchangeCodeForTokens(\r\n  env: Env,\r\n  code: string,\r\n  redirectUri: string,\r\n): Promise<{ access_token: string; refresh_token: string; expires_in: number }> {\r\n  const tokenUrl = env.ST_TOKEN_URL || \"https://auth-global.api.smartthings.com/oauth/token\";\r\n  const body = new URLSearchParams({\r\n    grant_type: \"authorization_code\",\r\n    code,\r\n    client_id: env.ST_CLIENT_ID,\r\n    redirect_uri: redirectUri,\r\n  });\r\n\r\n  const basic = btoa(`${env.ST_CLIENT_ID}:${env.ST_CLIENT_SECRET}`);\r\n  const resp = await fetch(tokenUrl, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"content-type\": \"application/x-www-form-urlencoded\",\r\n      accept: \"application/json\",\r\n      authorization: `Basic ${basic}`,\r\n    },\r\n    body,\r\n  });\r\n\r\n  const text = await resp.text();\r\n  if (!resp.ok) {\r\n    throw new Error(`Token exchange failed (${resp.status}): ${text}`);\r\n  }\r\n\r\n  return JSON.parse(text) as { access_token: string; refresh_token: string; expires_in: number };\r\n}\r\n\r\nasync function refreshAccessToken(\r\n  env: Env,\r\n  refreshToken: string,\r\n): Promise<{ access_token: string; refresh_token?: string; expires_in: number }> {\r\n  const tokenUrl = env.ST_TOKEN_URL || \"https://auth-global.api.smartthings.com/oauth/token\";\r\n  const body = new URLSearchParams({\r\n    grant_type: \"refresh_token\",\r\n    refresh_token: refreshToken,\r\n    client_id: env.ST_CLIENT_ID,\r\n  });\r\n\r\n  const basic = btoa(`${env.ST_CLIENT_ID}:${env.ST_CLIENT_SECRET}`);\r\n  const resp = await fetch(tokenUrl, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"content-type\": \"application/x-www-form-urlencoded\",\r\n      accept: \"application/json\",\r\n      authorization: `Basic ${basic}`,\r\n    },\r\n    body,\r\n  });\r\n\r\n  const text = await resp.text();\r\n  if (!resp.ok) {\r\n    throw new Error(`Token refresh failed (${resp.status}): ${text}`);\r\n  }\r\n\r\n  return JSON.parse(text) as { access_token: string; refresh_token?: string; expires_in: number };\r\n}\r\n\r\nfunction htmlPage(title: string, bodyHtml: string): Response {\r\n  const html = `<!doctype html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"utf-8\" />\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n  <title>${title}</title>\r\n  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:720px;margin:40px auto;padding:0 16px;line-height:1.45}code{background:#f2f2f2;padding:2px 4px;border-radius:4px}</style>\r\n</head>\r\n<body>\r\n${bodyHtml}\r\n</body>\r\n</html>`;\r\n  return new Response(html, {\r\n    headers: {\r\n      \"content-type\": \"text/html; charset=utf-8\",\r\n      \"cache-control\": \"no-store\",\r\n    },\r\n  });\r\n}\r\n\r\nexport default {\r\n  async fetch(req: Request, env: Env): Promise<Response> {\r\n    const url = new URL(req.url);\r\n\r\n    if (req.method === \"OPTIONS\") {\r\n      return withCors(req, new Response(null, { status: 204 }));\r\n    }\r\n\r\n    const respond = (r: Response) => withCors(req, r);\r\n\r\n    if (req.method === \"GET\" && url.pathname === \"/health\") {\r\n      return respond(json({ ok: true, time: nowIso() }));\r\n    }\r\n\r\n    // Create a pairing session and return the authorize URL.\r\n    if (req.method === \"POST\" && url.pathname === \"/v1/pair\") {\r\n      // Use a hex-only state to avoid any overly strict OAuth parsers.\r\n      const pairId = randomHex(18);\r\n      const { authorizeUrl, redirectUri } = getUrls(env);\r\n\r\n      // Optional debugging controls:\r\n      // - /v1/pair?no_scope=1 -> omit scope param entirely\r\n      // - /v1/pair?scopes=... -> override requested scopes (space-delimited)\r\n      const noScope = url.searchParams.get(\"no_scope\") === \"1\";\r\n      const scopesOverride = url.searchParams.get(\"scopes\");\r\n      const scopes = (scopesOverride ?? env.ST_SCOPES ?? \"r:devices:* x:devices:*\").trim();\r\n      const state = pairId;\r\n\r\n      const encodedScopes = encodeScopesForSmartThings(scopes);\r\n\r\n      // Build the authorize URL query string manually.\r\n      // Reason: URLSearchParams encodes spaces as '+', but some OAuth servers are strict and expect '%20'.\r\n      // Also, encoding '*' as '%2A' avoids edge cases with overly strict parsers.\r\n      const authUrl = new URL(authorizeUrl);\r\n      const queryParts = [\r\n        `response_type=code`,\r\n        `client_id=${encodeURIComponent(env.ST_CLIENT_ID)}`,\r\n        `redirect_uri=${encodeURIComponent(redirectUri)}`,\r\n        ...(noScope ? [] : [`scope=${encodedScopes}`]),\r\n        `state=${encodeURIComponent(state)}`,\r\n      ];\r\n      authUrl.search = queryParts.join(\"&\");\r\n\r\n      const record: PairRecord = { status: \"pending\", createdAt: nowIso() };\r\n      await env.AUTH_KV.put(`pair:${pairId}`, JSON.stringify(record), { expirationTtl: 15 * 60 });\r\n\r\n      return respond(\r\n        json({\r\n          pairId,\r\n          authorizationUrl: authUrl.toString(),\r\n          expiresInSeconds: 15 * 60,\r\n          debug: {\r\n            authorizeUrl,\r\n            redirectUri,\r\n            scopes,\r\n            noScope,\r\n            clientId: env.ST_CLIENT_ID,\r\n          },\r\n        }),\r\n      );\r\n    }\r\n\r\n    // OAuth callback from SmartThings.\r\n    if (req.method === \"GET\" && url.pathname === \"/v1/callback\") {\r\n      const code = url.searchParams.get(\"code\");\r\n      const state = url.searchParams.get(\"state\");\r\n      const oauthError = url.searchParams.get(\"error\");\r\n      const oauthErrorDescription = url.searchParams.get(\"error_description\");\r\n\r\n      const rawQuery = url.search ? url.search.slice(1) : \"\";\r\n\r\n      if (oauthError) {\r\n        const msg = `SmartThings returned an OAuth error: ${oauthError}${oauthErrorDescription ? ` - ${oauthErrorDescription}` : \"\"}`;\r\n\r\n        if (state) {\r\n          const pairKey = `pair:${state}`;\r\n          const pairRaw = await env.AUTH_KV.get(pairKey);\r\n          if (pairRaw) {\r\n            const pair = JSON.parse(pairRaw) as PairRecord;\r\n            if (pair.status === \"pending\") {\r\n              const updatedPair: PairRecord = { ...pair, status: \"error\", error: msg };\r\n              await env.AUTH_KV.put(pairKey, JSON.stringify(updatedPair), { expirationTtl: 15 * 60 });\r\n            }\r\n          }\r\n        }\r\n\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth - Error\",\r\n            `<h1>Authentication failed</h1>\r\n             <p>${escapeHtml(msg)}</p>\r\n             ${rawQuery ? `<h2>Callback Query</h2><pre>${escapeHtml(rawQuery)}</pre>` : \"\"}\r\n             <p>Return to Raycast and try again.</p>`,\r\n          ),\r\n        );\r\n      }\r\n      if (!code || !state) {\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth - Error\",\r\n            `<h1>Authentication failed</h1><p>Missing <code>code</code> or <code>state</code>.</p>`,\r\n          ),\r\n        );\r\n      }\r\n\r\n      const pairKey = `pair:${state}`;\r\n      const pairRaw = await env.AUTH_KV.get(pairKey);\r\n      if (!pairRaw) {\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth - Error\",\r\n            `<h1>Authentication failed</h1><p>This login session is not recognized or has expired. Return to Raycast and try again.</p>`,\r\n          ),\r\n        );\r\n      }\r\n\r\n      const pair = JSON.parse(pairRaw) as PairRecord;\r\n      if (pair.status !== \"pending\") {\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth\",\r\n            `<h1>Already connected</h1><p>You can close this tab and return to Raycast.</p>`,\r\n          ),\r\n        );\r\n      }\r\n\r\n      try {\r\n        const { redirectUri } = getUrls(env);\r\n        const tokenResp = await exchangeCodeForTokens(env, code, redirectUri);\r\n\r\n        const aesKey = await importAesKeyFromB64(env.TOKEN_ENC_KEY_B64);\r\n        const sessionToken = randomBase64Url(32);\r\n\r\n        const accessTokenExpiresAt = addSeconds(nowIso(), tokenResp.expires_in);\r\n        const tokenRecord: TokenRecord = {\r\n          updatedAt: nowIso(),\r\n          accessTokenEnc: await encryptString(aesKey, tokenResp.access_token),\r\n          accessTokenExpiresAt,\r\n          refreshTokenEnc: await encryptString(aesKey, tokenResp.refresh_token),\r\n        };\r\n\r\n        // Persist tokens keyed by session token (Raycast will store this session token).\r\n        await env.AUTH_KV.put(`token:${sessionToken}`, JSON.stringify(tokenRecord));\r\n\r\n        // Mark pair as completed so Raycast can poll for the session token.\r\n        const updatedPair: PairRecord = { ...pair, status: \"completed\", sessionToken };\r\n        await env.AUTH_KV.put(pairKey, JSON.stringify(updatedPair), { expirationTtl: 15 * 60 });\r\n\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth - Connected\",\r\n            `<h1>Connected</h1>\r\n             <p>You can close this tab and return to Raycast.</p>`,\r\n          ),\r\n        );\r\n      } catch (err) {\r\n        const msg = err instanceof Error ? err.message : String(err);\r\n        const updatedPair: PairRecord = { ...pair, status: \"error\", error: msg };\r\n        await env.AUTH_KV.put(pairKey, JSON.stringify(updatedPair), { expirationTtl: 15 * 60 });\r\n        return respond(\r\n          htmlPage(\r\n            \"SmartThings Auth - Error\",\r\n            `<h1>Authentication failed</h1><p>${escapeHtml(msg)}</p><p>Return to Raycast and try again.</p>`,\r\n          ),\r\n        );\r\n      }\r\n    }\r\n\r\n    // Poll pairing status (Raycast calls this until completed).\r\n    if (req.method === \"GET\" && url.pathname.startsWith(\"/v1/pair/\")) {\r\n      const pairId = url.pathname.split(\"/\").pop();\r\n      if (!pairId) return respond(notFound());\r\n\r\n      const pairRaw = await env.AUTH_KV.get(`pair:${pairId}`);\r\n      if (!pairRaw) return respond(notFound());\r\n\r\n      const pair = JSON.parse(pairRaw) as PairRecord;\r\n      // Return sessionToken only once it exists.\r\n      return respond(json({ status: pair.status, sessionToken: pair.sessionToken, error: pair.error }));\r\n    }\r\n\r\n    // Return a valid SmartThings access token (refreshing if needed).\r\n    if (req.method === \"POST\" && url.pathname === \"/v1/access-token\") {\r\n      const sessionToken = getBearerToken(req);\r\n      if (!sessionToken) return respond(unauthorized());\r\n\r\n      const tokenKey = `token:${sessionToken}`;\r\n      const tokenRaw = await env.AUTH_KV.get(tokenKey);\r\n      if (!tokenRaw) return respond(unauthorized(\"Invalid session\"));\r\n\r\n      const aesKey = await importAesKeyFromB64(env.TOKEN_ENC_KEY_B64);\r\n      const record = JSON.parse(tokenRaw) as TokenRecord;\r\n\r\n      const expiresAt = new Date(record.accessTokenExpiresAt).getTime();\r\n      const now = Date.now();\r\n\r\n      // If token is still valid for at least 60 seconds, return it.\r\n      if (expiresAt - now > 60_000) {\r\n        const accessToken = await decryptString(aesKey, record.accessTokenEnc);\r\n        return respond(json({ accessToken, expiresAt: record.accessTokenExpiresAt }));\r\n      }\r\n\r\n      // Refresh.\r\n      const refreshToken = await decryptString(aesKey, record.refreshTokenEnc);\r\n      const refreshed = await refreshAccessToken(env, refreshToken);\r\n\r\n      const newExpiresAt = addSeconds(nowIso(), refreshed.expires_in);\r\n      const newRecord: TokenRecord = {\r\n        updatedAt: nowIso(),\r\n        accessTokenEnc: await encryptString(aesKey, refreshed.access_token),\r\n        accessTokenExpiresAt: newExpiresAt,\r\n        refreshTokenEnc: refreshed.refresh_token\r\n          ? await encryptString(aesKey, refreshed.refresh_token)\r\n          : record.refreshTokenEnc,\r\n      };\r\n\r\n      await env.AUTH_KV.put(tokenKey, JSON.stringify(newRecord));\r\n\r\n      return respond(json({ accessToken: refreshed.access_token, expiresAt: newExpiresAt }));\r\n    }\r\n\r\n    // Logout (delete stored tokens).\r\n    if (req.method === \"POST\" && url.pathname === \"/v1/logout\") {\r\n      const sessionToken = getBearerToken(req);\r\n      if (!sessionToken) return respond(unauthorized());\r\n      await env.AUTH_KV.delete(`token:${sessionToken}`);\r\n      return respond(json({ ok: true }));\r\n    }\r\n\r\n    return respond(notFound());\r\n  },\r\n};\r\n"],
  "mappings": "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",
  "names": ["pairKey", "pairRaw", "pair"]
}
